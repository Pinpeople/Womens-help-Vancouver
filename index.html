<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Women’s Help — Vancouver</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#111111">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">
  <link rel="icon" href="./icon-192.png">

  <!-- Leaflet (simple map) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --bg:#f6f7f8; --card:#fff; --text:#111; --muted:#555; --stroke:#e6e6e6;
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    header{ padding:22px 18px 10px; max-width:980px; margin:0 auto; }
    h1{ margin:0 0 8px; font-size:34px; letter-spacing:-0.4px; }
    p{ margin:0; color:var(--muted); line-height:1.35; }

    .wrap{ max-width:980px; margin:0 auto; padding:12px 12px 28px; }

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin:12px 6px 14px; align-items:center; }
    .search{
      flex: 1 1 280px;
      background:#fff; border:1px solid var(--stroke);
      border-radius:14px; padding:12px 14px; font-size:16px;
    }
    .pill{
      background:#fff; border:1px solid var(--stroke);
      border-radius:999px; padding:10px 12px; font-size:14px; color:var(--muted);
      display:flex; gap:8px; align-items:center;
    }
    .btnTop{
      background:#fff; border:1px solid var(--stroke);
      border-radius:14px; padding:10px 12px; font-size:14px; font-weight:700;
      cursor:pointer;
    }

    .mapCard{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:10px;
      margin:0 6px 14px;
      overflow:hidden;
    }
    #map{ height:260px; border-radius:14px; overflow:hidden; }
    .mapHint{ margin:10px 2px 0; color:var(--muted); font-size:13px; }

    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; padding:0 6px; }
    @media (min-width:720px){ .grid{ grid-template-columns: 1fr 1fr; } }

    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius);
      padding:14px; box-shadow: 0 1px 0 rgba(0,0,0,0.02);
    }
    .name{ font-size:18px; font-weight:800; margin:0 0 4px; }
    .meta{ font-size:14px; color:var(--muted); margin:0 0 10px; line-height:1.35; }
    .tagrow{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 0; }
    .tag{ font-size:12px; padding:6px 8px; border-radius:999px; border:1px solid var(--stroke); color:var(--muted); background:#fafafa; }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    a.btn{
      display:inline-block; text-decoration:none; color:#111;
      background:#fff; border:1px solid var(--stroke);
      padding:10px 12px; border-radius:14px; font-weight:800; font-size:14px;
    }
    a.btn.primary{ background:#111; color:#fff; border-color:#111; }

    footer{ max-width:980px; margin:0 auto; padding:8px 18px 30px; color:var(--muted); font-size:13px; }
    .small{ font-size:12px; color:var(--muted); }
  </style>

  <!-- Load your data -->
  <script defer src="./shelters.js"></script>

  <!-- Leaflet JS -->
  <script
    defer
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
</head>

<body>
  <header>
    <h1>Women’s Help — Vancouver</h1>
    <p>Quick contacts + directions. Search by name, address, or notes. Works offline once opened.</p>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <input id="q" class="search" placeholder="Search (name, address, notes)..." autocomplete="off" />
      <button id="nearBtn" class="btnTop" type="button">Near me</button>
      <button id="resetBtn" class="btnTop" type="button">Reset</button>
      <div class="pill" id="count"><span style="width:10px;height:10px;border-radius:999px;background:#2bb24c;display:inline-block;"></span><span>0 listed</span></div>
    </div>

    <div class="mapCard">
      <div id="map"></div>
      <div class="mapHint">Tip: Tap a marker to open that place. “Near me” sorts the list and zooms closer.</div>
    </div>

    <div class="grid" id="list"></div>
  </div>

  <footer>
    <div class="small">
      Tip: On iPhone (Safari) → Share → <b>Add to Home Screen</b> to use it like an app.<br/>
      If something looks “stuck”, clear site data or unregister the Service Worker, then refresh.
    </div>
  </footer>

<script>
  // --- Service worker ---
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("./service-worker.js"));
  }

  // --- Helpers ---
  const $ = (id) => document.getElementById(id);
  const enc = (s) => encodeURIComponent(s || "");
  const fmtPhone = (p) => (p || "").replace(/[^\d+]/g, "");
  const appleMaps = (addr) => `https://maps.apple.com/?q=${enc(addr)}`;
  const googleMaps = (addr) => `https://www.google.com/maps/search/?api=1&query=${enc(addr)}`;

  function haversineKm(aLat, aLon, bLat, bLon) {
    const R = 6371;
    const toRad = (x) => x * Math.PI / 180;
    const dLat = toRad(bLat - aLat);
    const dLon = toRad(bLon - aLon);
    const lat1 = toRad(aLat);
    const lat2 = toRad(bLat);
    const s =
      Math.sin(dLat/2)**2 +
      Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(s), Math.sqrt(1 - s));
    return R * c;
  }

  // --- State ---
  let shelters = Array.isArray(window.SHELTERS) ? window.SHELTERS.slice() : [];
  let userLoc = null; // {lat, lon}
  let sortByNear = false;

  // --- Map ---
  let map, markersLayer;

  function initMap() {
    // Default center: downtown-ish Vancouver
    map = L.map("map", { zoomControl: true }).setView([49.2827, -123.1207], 12);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    markersLayer = L.layerGroup().addTo(map);
  }

  function rebuildMarkers(items) {
    if (!markersLayer) return;
    markersLayer.clearLayers();

    const pts = [];

    for (const s of items) {
      if (typeof s.lat === "number" && typeof s.lon === "number") {
        const m = L.marker([s.lat, s.lon]);
        const addr = s.address || "";
        const g = addr ? googleMaps(addr) : "";
        const a = addr ? appleMaps(addr) : "";
        m.bindPopup(`
          <b>${s.name || "Place"}</b><br/>
          ${addr ? `${addr}<br/>` : ""}
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
            ${s.phone ? `<a href="tel:${fmtPhone(s.phone)}">Call</a>` : ""}
            ${s.email ? `<a href="mailto:${s.email}">Email</a>` : ""}
            ${addr ? `<a href="${a}" target="_blank" rel="noopener">Apple Maps</a>` : ""}
            ${addr ? `<a href="${g}" target="_blank" rel="noopener">Google Maps</a>` : ""}
          </div>
        `);
        m.addTo(markersLayer);
        pts.push([s.lat, s.lon]);
      }
    }

    if (pts.length) {
      const bounds = L.latLngBounds(pts);
      map.fitBounds(bounds.pad(0.15));
    }
  }

  // --- UI rendering ---
  function card(s) {
    const tel = s.phone ? `tel:${fmtPhone(s.phone)}` : "";
    const mail = s.email ? `mailto:${s.email}` : "";
    const dirApple = s.address ? appleMaps(s.address) : "";
    const dirGoogle = s.address ? googleMaps(s.address) : "";
    const tag = s.type || s.kind || "Resource";

    return `
      <div class="card">
        <div class="name">${s.name || "Unknown"}</div>
        <div class="meta">
          ${s.address ? `<div><b>Address:</b> ${s.address}</div>` : ""}
          ${s.notes ? `<div style="margin-top:6px;">${s.notes}</div>` : ""}
          ${
            (userLoc && typeof s.lat === "number" && typeof s.lon === "number")
              ? `<div style="margin-top:6px;"><b>Distance:</b> ${haversineKm(userLoc.lat, userLoc.lon, s.lat, s.lon).toFixed(1)} km</div>`
              : ``
          }
        </div>
        <div class="tagrow"><span class="tag">${tag}</span></div>
        <div class="btns">
          ${s.phone ? `<a class="btn primary" href="${tel}">Call</a>` : ``}
          ${s.email ? `<a class="btn" href="${mail}">Email</a>` : ``}
          ${s.address ? `<a class="btn" href="${dirApple}" target="_blank" rel="noopener">Directions (Apple)</a>` : ``}
          ${s.address ? `<a class="btn" href="${dirGoogle}" target="_blank" rel="noopener">Directions (Google)</a>` : ``}
        </div>
      </div>
    `;
  }

  function render() {
    const q = ($("q").value || "").toLowerCase().trim();

    let items = shelters.filter(s => {
      const blob = `${s.name||""} ${s.type||s.kind||""} ${s.address||""} ${s.phone||""} ${s.email||""} ${s.notes||""}`.toLowerCase();
      return blob.includes(q);
    });

    if (sortByNear && userLoc) {
      items = items.slice().sort((a, b) => {
        if (typeof a.lat !== "number" || typeof a.lon !== "number") return 1;
        if (typeof b.lat !== "number" || typeof b.lon !== "number") return -1;
        return haversineKm(userLoc.lat, userLoc.lon, a.lat, a.lon) - haversineKm(userLoc.lat, userLoc.lon, b.lat, b.lon);
      });
    }

    $("list").innerHTML = items.map(card).join("");
    $("count").innerHTML = `<span style="width:10px;height:10px;border-radius:999px;background:#2bb24c;display:inline-block;"></span><span>${items.length} listed</span>`;

    rebuildMarkers(items);
  }

  async function setNearMe() {
    if (!navigator.geolocation) {
      alert("Geolocation not available in this browser.");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        userLoc = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        sortByNear = true;

        if (map) {
          map.setView([userLoc.lat, userLoc.lon], 13);
          L.circleMarker([userLoc.lat, userLoc.lon], { radius: 7 }).addTo(markersLayer).bindPopup("<b>You are here</b>");
        }

        render();
      },
      (err) => {
        alert("Couldn’t get your location (permission denied or unavailable).");
        console.warn(err);
      },
      { enableHighAccuracy: false, timeout: 8000, maximumAge: 60000 }
    );
  }

  function resetAll() {
    $("q").value = "";
    sortByNear = false;
    userLoc = null;
    render();
  }

  // Boot
  window.addEventListener("load", () => {
    // If shelters.js failed to parse, this will be empty:
    shelters = Array.isArray(window.SHELTERS) ? window.SHELTERS.slice() : [];
    initMap();
    $("q").addEventListener("input", render);
    $("nearBtn").addEventListener("click", setNearMe);
    $("resetBtn").addEventListener("click", resetAll);
    render();
  });
</script>
</body>
</html>
