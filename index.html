<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Women’s Help — Vancouver</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#111111">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">

  <!-- Optional: prevent iOS from auto-linking random numbers; we explicitly make tel: links -->
  <meta name="format-detection" content="telephone=no">

  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --text:#101010;
      --muted:#5b5b5b;
      --stroke:#e6e6e6;
      --shadow: 0 1px 0 rgba(0,0,0,0.03);
      --radius:18px;
      --radius2:14px;
      --pad:14px;
      --max: 980px;
      --primary:#111111;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    a{ color:inherit; }

    header{
      padding:22px 18px 12px;
      max-width:var(--max);
      margin:0 auto;
    }

    h1{
      margin:0 0 6px;
      font-size:34px;
      letter-spacing:-0.5px;
      line-height:1.08;
    }

    .sub{
      margin:0;
      color:var(--muted);
      line-height:1.35;
      font-size:15px;
    }

    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding:12px 12px 28px;
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin:12px 6px 12px;
    }

    .search{
      flex: 1 1 260px;
      background:#fff;
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:12px 14px;
      font-size:16px;
      outline:none;
    }
    .search:focus{ border-color:#cfcfcf; }

    .btnpill{
      border:1px solid var(--stroke);
      background:#fff;
      color:var(--text);
      border-radius:999px;
      padding:10px 12px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
    }
    .btnpill:active{ transform: translateY(1px); }
    .btnpill.primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
    }
    .btnpill.ghost{
      background:#fff;
      color:var(--muted);
      font-weight:600;
    }

    .statusrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin:0 6px 14px;
      color:var(--muted);
      font-size:13px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:999px;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;background:#bbb;
    }
    .dot.ok{ background:#2aa84a; }
    .dot.warn{ background:#f0b429; }

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media (min-width:760px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:var(--pad);
      box-shadow:var(--shadow);
    }

    .topline{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }

    .name{
      font-size:18px;
      font-weight:800;
      margin:0;
      line-height:1.2;
    }

    .tag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      color:var(--muted);
      background:#fafafa;
      white-space:nowrap;
      height:fit-content;
    }

    .meta{
      margin-top:8px;
      font-size:14px;
      color:var(--muted);
      line-height:1.35;
    }
    .meta b{ color:var(--text); }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    a.btn{
      display:inline-block;
      text-decoration:none;
      color:var(--text);
      background:#fff;
      border:1px solid var(--stroke);
      padding:10px 12px;
      border-radius:var(--radius2);
      font-weight:750;
      font-size:14px;
    }
    a.btn.primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
    }

    .empty{
      padding:18px 10px;
      color:var(--muted);
      text-align:center;
    }

    footer{
      max-width:var(--max);
      margin:0 auto;
      padding:6px 18px 26px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .small{
      font-size:12px;
      color:var(--muted);
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
      border:1px solid var(--stroke);
      background:#fff;
      padding:2px 6px;
      border-radius:8px;
      color:var(--text);
    }
  </style>
</head>

<body>
  <header>
    <h1>Women’s Help — Vancouver</h1>
    <p class="sub">
      Quick contacts + directions. Search by name, address, or notes. Works offline once opened.
    </p>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <input id="q" class="search" placeholder="Search (name, address, notes)…" autocomplete="off" />
      <button id="nearBtn" class="btnpill">Near me</button>
      <button id="resetBtn" class="btnpill ghost" title="Clear search + sorting">Reset</button>
    </div>

    <div class="statusrow">
      <span class="badge" id="countBadge"><span class="dot"></span><span id="count">0 listed</span></span>
      <span class="badge" id="offlineBadge" style="display:none;"><span class="dot warn"></span><span>Offline mode</span></span>
      <span class="badge" id="nearBadge" style="display:none;"><span class="dot ok"></span><span id="nearText">Sorting by distance</span></span>
    </div>

    <div class="grid" id="list"></div>
    <div class="empty" id="empty" style="display:none;">No matches. Try a different search.</div>
  </div>

  <footer>
    <div class="small">
      Tip: On iPhone (Safari) → Share → <b>Add to Home Screen</b> to use it like an app.<br>
      If you update files and things look “stuck”, refresh once or clear site data (PWA cache).
    </div>
  </footer>

  <!-- Data -->
  <script src="./shelters.js"></script>

  <script>
    // Register service worker (PWA offline)
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(() => {});
      });
    }

    // Helpers
    const $ = (id) => document.getElementById(id);
    const enc = (s) => encodeURIComponent(s || "");
    const fmtPhone = (p) => (p || "").replace(/[^\d+]/g, "");
    const appleMaps = (addr) => `https://maps.apple.com/?q=${enc(addr)}`;
    const googleMaps = (addr) => `https://www.google.com/maps/search/?api=1&query=${enc(addr)}`;

    function distanceKm(aLat, aLon, bLat, bLon){
      // Haversine
      const R = 6371;
      const toRad = (x) => x * Math.PI / 180;
      const dLat = toRad(bLat - aLat);
      const dLon = toRad(bLon - aLon);
      const lat1 = toRad(aLat);
      const lat2 = toRad(bLat);

      const s = Math.sin(dLat/2) ** 2 +
                Math.cos(lat1) * Math.cos(lat2) * (Math.sin(dLon/2) ** 2);
      const c = 2 * Math.atan2(Math.sqrt(s), Math.sqrt(1 - s));
      return R * c;
    }

    // State
    const raw = Array.isArray(window.SHELTERS) ? window.SHELTERS.slice() : [];
    let shelters = raw.slice();
    let userLoc = null;           // {lat, lon}
    let sortByNear = false;

    // Elements
    const $list = $("list");
    const $q = $("q");
    const $count = $("count");
    const $empty = $("empty");
    const $countBadge = $("countBadge");
    const $offlineBadge = $("offlineBadge");
    const $nearBadge = $("nearBadge");
    const $nearText = $("nearText");
    const $nearBtn = $("nearBtn");
    const $resetBtn = $("resetBtn");

    // Offline indicator
    function updateOnlineUI(){
      const online = navigator.onLine;
      $offlineBadge.style.display = online ? "none" : "inline-flex";
    }
    window.addEventListener("online", updateOnlineUI);
    window.addEventListener("offline", updateOnlineUI);
    updateOnlineUI();

    function normalizeShelter(s){
      return {
        name: (s.name || "").trim(),
        type: (s.type || s.kind || "").trim(),
        address: (s.address || "").trim(),
        phone: (s.phone || "").trim(),
        email: (s.email || "").trim(),
        notes: (s.notes || "").trim(),
        lat: typeof s.lat === "number" ? s.lat : null,
        lon: typeof s.lon === "number" ? s.lon : null
      };
    }

    function card(p){
      const tel = p.phone ? `tel:${fmtPhone(p.phone)}` : "";
      const mail = p.email ? `mailto:${p.email}` : "";
      const dirApple = p.address ? appleMaps(p.address) : "";
      const dirGoogle = p.address ? googleMaps(p.address) : "";

      let distLine = "";
      if (sortByNear && userLoc && p.lat != null && p.lon != null) {
        const km = distanceKm(userLoc.lat, userLoc.lon, p.lat, p.lon);
        distLine = `<div style="margin-top:6px;"><b>Distance:</b> ${km.toFixed(1)} km</div>`;
      }

      const tag = p.type ? `<span class="tag">${p.type}</span>` : "";

      return `
        <div class="card">
          <div class="topline">
            <h2 class="name">${p.name || "Untitled"}</h2>
            ${tag}
          </div>

          <div class="meta">
            ${p.address ? `<div><b>Address:</b> ${p.address}</div>` : ""}
            ${p.notes ? `<div style="margin-top:6px;">${p.notes}</div>` : ""}
            ${distLine}
          </div>

          <div class="btns">
            ${p.phone ? `<a class="btn primary" href="${tel}">Call</a>` : ``}
            ${p.email ? `<a class="btn" href="${mail}">Email</a>` : ``}
            ${p.address ? `<a class="btn" href="${dirApple}" target="_blank" rel="noopener">Directions (Apple)</a>` : ``}
            ${p.address ? `<a class="btn" href="${dirGoogle}" target="_blank" rel="noopener">Directions (Google)</a>` : ``}
          </div>
        </div>
      `;
    }

    function applySearchAndRender(){
      const query = ($q.value || "").toLowerCase().trim();
      let filtered = shelters.filter(p => {
        const blob = `${p.name} ${p.type} ${p.address} ${p.phone} ${p.email} ${p.notes}`.toLowerCase();
        return blob.includes(query);
      });

      $list.innerHTML = filtered.map(card).join("");
      $count.textContent = `${filtered.length} listed`;
      $empty.style.display = filtered.length ? "none" : "block";

      // nice badge dot
      const dot = $countBadge.querySelector(".dot");
      if (dot) dot.className = "dot ok";
    }

    function setNearBadge(on, text){
      $nearBadge.style.display = on ? "inline-flex" : "none";
      if (text) $nearText.textContent = text;
    }

    async function requestLocationAndSort(){
      if (!("geolocation" in navigator)) {
        setNearBadge(true, "Location not supported on this device");
        return;
      }

      // If we already have a location, just toggle sort off/on
      if (userLoc && sortByNear) {
        sortByNear = false;
        shelters = raw.map(normalizeShelter);
        setNearBadge(false);
        $nearBtn.classList.remove("primary");
        $nearBtn.textContent = "Near me";
        applySearchAndRender();
        return;
      }

      $nearBtn.textContent = "Locating…";
      $nearBtn.disabled = true;

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          userLoc = { lat: pos.coords.latitude, lon: pos.coords.longitude };
          sortByNear = true;

          const normalized = raw.map(normalizeShelter);

          // Only sort by distance for entries with lat/lon; keep others at the end
          normalized.sort((a, b) => {
            const aHas = a.lat != null && a.lon != null;
            const bHas = b.lat != null && b.lon != null;
            if (!aHas && !bHas) return 0;
            if (!aHas) return 1;
            if (!bHas) return -1;

            const da = distanceKm(userLoc.lat, userLoc.lon, a.lat, a.lon);
            const db = distanceKm(userLoc.lat, userLoc.lon, b.lat, b.lon);
            return da - db;
          });

          shelters = normalized;

          setNearBadge(true, "Sorting by distance (needs lat/lon in shelters.js)");
          $nearBtn.classList.add("primary");
          $nearBtn.textContent = "Near me ✓";
          $nearBtn.disabled = false;
          applySearchAndRender();
        },
        (err) => {
          sortByNear = false;
          userLoc = null;

          let msg = "Location denied";
          if (err && err.code === 1) msg = "Location denied";
          if (err && err.code === 2) msg = "Location unavailable";
          if (err && err.code === 3) msg = "Location timeout";

          setNearBadge(true, msg);
          $nearBtn.textContent = "Near me";
          $nearBtn.disabled = false;
        },
        { enableHighAccuracy: false, timeout: 8000, maximumAge: 60000 }
      );
    }

    function resetAll(){
      $q.value = "";
      shelters = raw.map(normalizeShelter);
      sortByNear = false;
      userLoc = null;
      setNearBadge(false);
      $nearBtn.classList.remove("primary");
      $nearBtn.textContent = "Near me";
      applySearchAndRender();
      $q.focus();
    }

    // Init
    shelters = raw.map(normalizeShelter);

    // Wire up
    $q.addEventListener("input", applySearchAndRender);
    $nearBtn.addEventListener("click", requestLocationAndSort);
    $resetBtn.addEventListener("click", resetAll);

    applySearchAndRender();
  </script>
</body>
</html>
