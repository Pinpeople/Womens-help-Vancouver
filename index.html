<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Women’s Help — Vancouver</title>
  <meta name="description" content="Quick contacts + directions for women’s shelters and supports in/near Vancouver. Works offline after first open." />

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#111111">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Women’s Help">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Women’s Help">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- Icons (your repo has these in ROOT) -->
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">
  <link rel="icon" href="./icon-192.png">

  <style>
    :root{
      --bg:#f6f7f8;
      --card:#fff;
      --text:#101114;
      --muted:#5b5f66;
      --stroke:#e6e6e8;
      --shadow: 0 1px 0 rgba(0,0,0,0.02);
      --radius:18px;
      --radius2:14px;
      --max: 980px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    a{ color:inherit; }
    header{
      max-width:var(--max);
      margin:0 auto;
      padding:24px 16px 8px;
    }
    h1{
      margin:0 0 8px;
      font-size:34px;
      letter-spacing:-0.5px;
      line-height:1.05;
    }
    .sub{
      margin:0;
      color:var(--muted);
      line-height:1.35;
      font-size:15px;
    }

    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding:10px 12px 26px;
    }

    /* Sticky toolbar */
    .sticky{
      position:sticky;
      top:0;
      z-index:10;
      background:linear-gradient(to bottom, rgba(246,247,248,0.98), rgba(246,247,248,0.92));
      backdrop-filter:saturate(180%) blur(10px);
      padding:10px 6px 10px;
      border-bottom:1px solid rgba(0,0,0,0.04);
      margin:0 0 10px;
    }
    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .search{
      flex: 1 1 260px;
      background:#fff;
      border:1px solid var(--stroke);
      border-radius:var(--radius2);
      padding:12px 14px;
      font-size:16px;
      outline:none;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:11px 12px;
      border-radius:var(--radius2);
      border:1px solid var(--stroke);
      background:#fff;
      font-weight:650;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
    }
    .btn.primary{
      background:#111;
      border-color:#111;
      color:#fff;
    }
    .btn:disabled{
      opacity:0.55;
      cursor:not-allowed;
    }
    .pill{
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background:#fff;
      color:var(--muted);
      font-size:14px;
      white-space:nowrap;
    }

    .filters{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:10px 0 0;
    }
    .chip{
      border:1px solid var(--stroke);
      background:#fff;
      color:var(--muted);
      border-radius:999px;
      padding:8px 10px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      border-color:#111;
      color:#111;
      box-shadow:0 0 0 1px #111 inset;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding:0 6px;
    }
    @media (min-width:760px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .name{
      margin:0 0 6px;
      font-size:18px;
      font-weight:800;
      letter-spacing:-0.2px;
      line-height:1.15;
    }
    .meta{
      color:var(--muted);
      font-size:14px;
      line-height:1.4;
    }
    .meta b{ color:#2b2f35; }
    .tagrow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .tag{
      font-size:12px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--stroke);
      color:var(--muted);
      background:#fafafa;
    }

    .btnrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    footer{
      max-width:var(--max);
      margin:0 auto;
      padding:10px 16px 30px;
      color:var(--muted);
      font-size:13px;
    }
    .tiny{ font-size:12px; color:var(--muted); line-height:1.35; }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      background:#111;
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition: opacity 180ms ease;
    }
    .toast.show{ opacity:0.92; }
  </style>
</head>

<body>
  <header>
    <h1>Women’s Help — Vancouver</h1>
    <p class="sub">Quick contacts + directions. Works offline after first open.</p>
  </header>

  <div class="wrap">
    <div class="sticky">
      <div class="toolbar">
        <input id="q" class="search" placeholder="Search (name, address, notes)..." autocomplete="off" />
        <button id="near" class="btn" type="button">Near me</button>
        <div id="count" class="pill">—</div>
      </div>
      <div id="filters" class="filters"></div>
    </div>

    <div id="list" class="grid"></div>
  </div>

  <footer>
    <div class="tiny">
      Tip (iPhone): Safari → Share → <b>Add to Home Screen</b> to make it behave like an app.<br>
      If something looks wrong after updates: hard refresh (Ctrl+Shift+R) or clear site data.
    </div>
  </footer>

  <div id="toast" class="toast"></div>

  <!-- Your data file -->
  <script src="./shelters.js"></script>

  <script>
    // Register service worker (PWA offline)
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(() => {});
      });
    }

    const $list = document.getElementById("list");
    const $q = document.getElementById("q");
    const $count = document.getElementById("count");
    const $near = document.getElementById("near");
    const $filters = document.getElementById("filters");
    const $toast = document.getElementById("toast");

    // Try to support whatever your shelters.js exposes
    // (examples: window.places, window.PLACES, window.SHELTERS)
    const DATA =
      (window.places && Array.isArray(window.places) && window.places) ||
      (window.PLACES && Array.isArray(window.PLACES) && window.PLACES) ||
      (window.SHELTERS && Array.isArray(window.SHELTERS) && window.SHELTERS) ||
      [];

    // Normalize records so the UI is consistent
    const places = DATA.map(p => ({
      name: p.name || "",
      kind: p.kind || p.type || "",
      address: p.address || "",
      phone: p.phone || "",
      email: p.email || "",
      notes: p.notes || p.description || "",
      lat: typeof p.lat === "number" ? p.lat : null,
      lon: typeof p.lon === "number" ? p.lon : null,
      distKm: null
    }));

    function toast(msg){
      $toast.textContent = msg;
      $toast.classList.add("show");
      setTimeout(() => $toast.classList.remove("show"), 2200);
    }

    const enc = (s) => encodeURIComponent(s || "");
    const fmtPhone = (p) => (p || "").replace(/[^\d+]/g, "");
    const appleMaps = (addr) => `https://maps.apple.com/?q=${enc(addr)}`;
    const googleMaps = (addr) => `https://www.google.com/maps/search/?api=1&query=${enc(addr)}`;

    // Simple distance calc (Haversine)
    function havKm(lat1, lon1, lat2, lon2){
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI/180;
      const dLon = (lon2 - lon1) * Math.PI/180;
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    let activeKind = "All";
    let sortByNearest = false;

    function buildFilters(){
      const kinds = ["All", ...Array.from(new Set(places.map(p => p.kind).filter(Boolean))).sort()];
      $filters.innerHTML = kinds.map(k => `
        <div class="chip ${k === activeKind ? "active" : ""}" data-kind="${k}">
          ${k}
        </div>
      `).join("");

      $filters.querySelectorAll(".chip").forEach(ch => {
        ch.addEventListener("click", () => {
          activeKind = ch.dataset.kind || "All";
          sortByNearest = false; // reset sort unless user taps Near me again
          render();
          buildFilters();
        });
      });
    }

    function card(p){
      const tel = p.phone ? `tel:${fmtPhone(p.phone)}` : "";
      const mail = p.email ? `mailto:${p.email}` : "";
      const dirApple = p.address ? appleMaps(p.address) : "";
      const dirGoogle = p.address ? googleMaps(p.address) : "";

      const tags = [
        p.kind ? `<span class="tag">${p.kind}</span>` : "",
        (typeof p.distKm === "number") ? `<span class="tag">${p.distKm.toFixed(p.distKm < 10 ? 1 : 0)} km</span>` : ""
      ].filter(Boolean).join("");

      return `
        <div class="card">
          <div class="name">${p.name || "Unknown"}</div>
          <div class="meta">
            ${p.address ? `<div><b>Address:</b> ${p.address}</div>` : ""}
            ${p.notes ? `<div style="margin-top:6px;">${p.notes}</div>` : ""}
          </div>

          ${tags ? `<div class="tagrow">${tags}</div>` : ""}

          <div class="btnrow">
            ${p.phone ? `<a class="btn primary" href="${tel}">Call</a>` : ``}
            ${p.email ? `<a class="btn" href="${mail}">Email</a>` : ``}
            ${p.address ? `<a class="btn" href="${dirApple}" target="_blank" rel="noopener">Directions (Apple)</a>` : ``}
            ${p.address ? `<a class="btn" href="${dirGoogle}" target="_blank" rel="noopener">Directions (Google)</a>` : ``}
          </div>
        </div>
      `;
    }

    function matchesQuery(p, query){
      if (!query) return true;
      const blob = `${p.name} ${p.kind} ${p.address} ${p.phone} ${p.email} ${p.notes}`.toLowerCase();
      return blob.includes(query);
    }

    function render(){
      const query = ($q.value || "").toLowerCase().trim();
      let items = places.filter(p => (activeKind === "All" ? true : p.kind === activeKind))
                        .filter(p => matchesQuery(p, query));

      if (sortByNearest) {
        // Only sort if we have distances calculated
        const hasAny = items.some(p => typeof p.distKm === "number");
        if (hasAny) {
          items = items.slice().sort((a,b) => (a.distKm ?? 1e9) - (b.distKm ?? 1e9));
        }
      }

      $list.innerHTML = items.map(card).join("");
      $count.textContent = `${items.length} listed`;
    }

    $q.addEventListener("input", render);

    $near.addEventListener("click", async () => {
      if (!navigator.geolocation) {
        toast("Location not supported on this device.");
        return;
      }

      $near.disabled = true;
      $near.textContent = "Locating...";

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;

          // If you later add lat/lon to shelters.js, this becomes super accurate.
          // For now, we’ll do “best effort”: only compute distance for entries that have lat/lon.
          let computed = 0;
          for (const p of places) {
            if (typeof p.lat === "number" && typeof p.lon === "number") {
              p.distKm = havKm(latitude, longitude, p.lat, p.lon);
              computed++;
            } else {
              p.distKm = null;
            }
          }

          sortByNearest = true;
          render();

          if (computed === 0) {
            toast("Add lat/lon in shelters.js for true “near me” sorting.");
          } else {
            toast("Sorted by nearest.");
          }

          $near.disabled = false;
          $near.textContent = "Near me";
        },
        () => {
          toast("Location permission denied.");
          $near.disabled = false;
          $near.textContent = "Near me";
        },
        { enableHighAccuracy: true, timeout: 9000, maximumAge: 30000 }
      );
    });

    buildFilters();
    render();
  </script>
</body>
</html>
